<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OCR Job Barcode Generator</title>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 20px; background: #fff;
    color: #00407a;
  }
  nav {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
  }
  nav button {
    background-color: #e87722;
    border: none;
    color: white;
    padding: 12px 20px;
    font-size: 1rem;
    cursor: pointer;
    border-radius: 4px;
    font-weight: bold;
    transition: background-color 0.3s ease;
    min-width: 120px;
  }
  nav button.active,
  nav button:hover {
    background-color: #d56c1e;
  }
  section {
    max-width: 720px;
    margin: 0 auto;
    border: 2px solid #e87722;
    padding: 20px 30px 30px 30px;
    border-radius: 10px;
  }
  label {
    display: block;
    margin-top: 15px;
    font-weight: 600;
    font-size: 1rem;
  }
  select, input[type="text"], input[type="date"] {
    margin-top: 6px;
    width: 100%;
    padding: 10px;
    font-size: 1rem;
    border: 1px solid #00407a;
    border-radius: 5px;
    box-sizing: border-box;
    color: #00407a;
  }
  .checkbox-group {
    margin-top: 10px;
    display: flex;
    gap: 20px;
  }
  .checkbox-group label {
    font-weight: normal;
    cursor: pointer;
  }
  button.primary {
    margin-top: 20px;
    width: 100%;
    background-color: #e87722;
    border: none;
    color: white;
    padding: 14px;
    font-size: 1.1rem;
    font-weight: 700;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button.primary:hover {
    background-color: #d56c1e;
  }
  #errorMessage {
    margin-top: 12px;
    color: red;
    font-weight: 700;
  }
  #result {
    margin-top: 25px;
    display: none;
    text-align: center;
  }
  #result strong {
    font-size: 1.3rem;
    color: #e87722;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  th, td {
    border: 1px solid #00407a;
    padding: 8px 12px;
    text-align: left;
    font-size: 1rem;
  }
  th {
    background-color: #e87722;
    color: white;
  }
  a.job-link {
    color: #e87722;
    cursor: pointer;
    text-decoration: underline;
  }
  /* Modal styles */
  #barcodeModal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  #barcodeModal.active {
    display: flex;
  }
  #barcodeModalContent {
    background: white;
    padding: 20px 30px;
    border-radius: 8px;
    text-align: center;
    max-width: 320px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    position: relative;
  }
  #closeModalBtn {
    position: absolute;
    top: 10px;
    right: 12px;
    background: transparent;
    border: none;
    font-size: 1.6rem;
    cursor: pointer;
    color: #555;
  }
</style>
</head>
<body>

<nav>
  <button id="tabCreate" class="active" type="button" aria-controls="createSection">Create Job</button>
  <button id="tabReport" type="button" aria-controls="reportSection">Job Reports</button>
  <button id="tabAssociate" type="button" aria-controls="associateSection">Associate Job Types</button>
</nav>

<section id="createSection" aria-label="Create Job Section">
  <label for="operatorInput">Operator <span style="color:red;">*</span></label>
  <input id="operatorInput" type="text" placeholder="Your name" autocomplete="off" required />

  <label for="jobTypeSelect">Job Type <span style="color:red;">*</span></label>
  <select id="jobTypeSelect" required>
    <option value="">-- select --</option>
    <option value="L">Letters (L)</option>
    <option value="M">Machinable (M)</option>
    <option value="A">All - Merge Letters (A)</option>
    <option value="F">First Class Flats (F)</option>
    <option value="D">Standard Flats (D)</option>
    <option value="T">Standard Letters (T)</option>
  </select>

  <label for="machineSelect">Machine Number <span style="color:red;">*</span></label>
  <select id="machineSelect" required>
    <option value="">-- select --</option>
    <option value="1">OCR 1</option>
    <option value="2">OCR 2</option>
  </select>

  <label for="jobDateInput">Date <span style="color:red;">*</span></label>
  <input id="jobDateInput" type="date" required />

  <button id="createBtn" class="primary" type="button">Create Job</button>
  <div id="errorMessage" role="alert" aria-live="assertive"></div>

  <div id="result" aria-live="polite" aria-atomic="true">
    <div>Job ID: <strong id="jobIdDisplay"></strong></div>
    <svg id="barcodeSvg"></svg>
  </div>
</section>

<section id="reportSection" aria-label="Job Reports Section" hidden>
  <label for="filterJobType">Filter by Job Type:</label>
  <select id="filterJobType" aria-label="Filter by Job Type">
    <option value="">All</option>
    <option value="L">Letters (L)</option>
    <option value="M">Machinable (M)</option>
    <option value="A">All - Merge Letters (A)</option>
    <option value="F">First Class Flats (F)</option>
    <option value="D">Standard Flats (D)</option>
    <option value="T">Standard Letters (T)</option>
  </select>

  <label for="filterOperator">Filter by Operator:</label>
  <input id="filterOperator" type="text" placeholder="Operator name" aria-label="Filter by Operator" />

  <label for="filterMachine">Filter by Machine:</label>
  <select id="filterMachine" aria-label="Filter by Machine">
    <option value="">All</option>
    <option value="1">OCR 1</option>
    <option value="2">OCR 2</option>
  </select>

  <label for="filterDateFrom">Filter by Date From:</label>
  <input id="filterDateFrom" type="date" aria-label="Filter by Date From" />

  <label for="filterDateTo">Filter by Date To:</label>
  <input id="filterDateTo" type="date" aria-label="Filter by Date To" />

  <button id="applyFiltersBtn" class="primary" type="button">Apply Filters</button>
  <button id="downloadCsvBtn" class="primary" style="margin-top:8px;" type="button">Download CSV</button>

  <table id="reportTable" aria-live="polite" aria-label="Job Reports Table">
    <thead>
      <tr>
        <th>Job ID</th>
        <th>Job Type</th>
        <th>Operator</th>
        <th>Machine</th>
        <th>Job Date</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<section id="associateSection" aria-label="Associate Job Types Section" hidden>
  <label for="selectJobId">Select Base Job ID (Letters, Machinable, or All):</label>
  <select id="selectJobId" aria-describedby="associateHelp" aria-required="true">
    <option value="">-- select --</option>
  </select>
  <div id="associateHelp" style="font-size: 0.9em; margin-bottom: 10px;">
    Choose a base job and associate other job types with the same Job ID sequence.
  </div>

  <fieldset>
    <legend>Select Job Types to Associate</legend>
    <div class="checkbox-group">
      <label><input type="checkbox" class="assocJobType" value="L" /> Letters (L)</label>
      <label><input type="checkbox" class="assocJobType" value="M" /> Machinable (M)</label>
      <label><input type="checkbox" class="assocJobType" value="A" /> All - Merge Letters (A)</label>
    </div>
  </fieldset>

  <button id="associateBtn" class="primary" type="button">Associate Job Types</button>
  <div id="associateResult" style="display:none; margin-top:10px;">
    <ul id="associateList"></ul>
  </div>
</section>

<!-- Barcode Modal -->
<div id="barcodeModal" role="dialog" aria-modal="true" aria-labelledby="modalJobId" tabindex="-1">
  <div id="barcodeModalContent">
    <button id="closeModalBtn" aria-label="Close">&times;</button>
    <h2>Job ID: <span id="modalJobId"></span></h2>
    <svg id="modalBarcode"></svg>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script>
  // Your Supabase info - replace these with your actual keys
  const SUPABASE_URL = 'https://vwsqtcsxxzkxcrdcbbky.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ3c3F0Y3N4eHpreGNyZGNiYmt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3ODY3MTIsImV4cCI6MjA2NjM2MjcxMn0.rN559kMiLeExnVyZmXxRLg3yYjJwWfwDlkzPuFX7qeA';
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Tab buttons and sections
  const tabs = {
    create: document.getElementById('tabCreate'),
    report: document.getElementById('tabReport'),
    associate: document.getElementById('tabAssociate'),
  };
  const sections = {
    create: document.getElementById('createSection'),
    report: document.getElementById('reportSection'),
    associate: document.getElementById('associateSection'),
  };

  // Tab switching
  function switchTab(tabName) {
    Object.keys(tabs).forEach(key => {
      const isActive = key === tabName;
      tabs[key].classList.toggle('active', isActive);
      sections[key].hidden = !isActive;
    });
    clearMessages();
    if (tabName === 'associate') loadAssociateJobIds();
    if (tabName === 'report') loadReport();
  }

  tabs.create.addEventListener('click', () => switchTab('create'));
  tabs.report.addEventListener('click', () => switchTab('report'));
  tabs.associate.addEventListener('click', () => switchTab('associate'));

  // Clear error & associate messages
  function clearMessages() {
    document.getElementById('errorMessage').textContent = '';
    document.getElementById('associateResult').style.display = 'none';
    document.getElementById('associateList').innerHTML = '';
  }

  // Create Job Section elements
  const operatorInput = document.getElementById('operatorInput');
  const jobTypeSelect = document.getElementById('jobTypeSelect');
  const machineSelect = document.getElementById('machineSelect');
  const jobDateInput = document.getElementById('jobDateInput');
  const createBtn = document.getElementById('createBtn');
  const resultDiv = document.getElementById('result');
  const jobIdDisplay = document.getElementById('jobIdDisplay');
  const barcodeSvg = document.getElementById('barcodeSvg');
  const errorMessage = document.getElementById('errorMessage');

  // Set default date to today
  jobDateInput.value = new Date().toISOString().slice(0, 10);

  createBtn.addEventListener('click', async () => {
    clearMessages();
    if (!operatorInput.value.trim() || !jobTypeSelect.value || !machineSelect.value || !jobDateInput.value) {
      errorMessage.textContent = 'Please fill in all required fields.';
      return;
    }
    const operator = operatorInput.value.trim();
    const jobType = jobTypeSelect.value;
    const machine = machineSelect.value;
    const jobDate = jobDateInput.value; // YYYY-MM-DD

    // Extract MMDD from jobDate
    const [year, month, day] = jobDate.split('-');
    const mmdd = month.padStart(2, '0') + day.padStart(2, '0');

    try {
      // Fetch existing jobs with matching pattern jobType + machine + MMDD + J + number
      const { data: existingJobs, error: fetchError } = await supabase
        .from('MoveComplyReport_md')
        .select('job_id')
        .ilike('job_id', `${jobType}${machine}${mmdd}J%`);
      if (fetchError) throw fetchError;

      let maxSeq = 0;
      existingJobs.forEach(job => {
        const match = job.job_id.match(/J(\d+)$/);
        if (match) {
          const seqNum = parseInt(match[1], 10);
          if (seqNum > maxSeq) maxSeq = seqNum;
        }
      });
      const nextSeq = maxSeq + 1;
      const jobId = `${jobType}${machine}${mmdd}J${nextSeq}`;

      // Insert the new job record
      const { error: insertError } = await supabase
        .from('MoveComplyReport_md')
        .insert([{ job_id: jobId, operator, job_type: jobType, machine, job_date: jobDate }]);
      if (insertError) throw insertError;

      // Show the barcode and job ID
      jobIdDisplay.textContent = jobId;
      JsBarcode(barcodeSvg, jobId, { format: 'CODE128', width: 2, height: 80 });
      resultDiv.style.display = 'block';

      // Clear inputs except date for fast entry
      operatorInput.value = '';
      jobTypeSelect.value = '';
      machineSelect.value = '';
    } catch (err) {
      errorMessage.textContent = 'Error creating job: ' + err.message;
    }
  });

  // Report section elements
  const filterJobType = document.getElementById('filterJobType');
  const filterOperator = document.getElementById('filterOperator');
  const filterMachine = document.getElementById('filterMachine');
  const filterDateFrom = document.getElementById('filterDateFrom');
  const filterDateTo = document.getElementById('filterDateTo');
  const applyFiltersBtn = document.getElementById('applyFiltersBtn');
  const downloadCsvBtn = document.getElementById('downloadCsvBtn');
  const reportTableBody = document.querySelector('#reportTable tbody');

  async function loadReport() {
    let query = supabase.from('MoveComplyReport_md').select('job_id, job_type, operator, machine, job_date');

    if (filterJobType.value) query = query.eq('job_type', filterJobType.value);
    if (filterOperator.value.trim()) query = query.ilike('operator', `%${filterOperator.value.trim()}%`);
    if (filterMachine.value) query = query.eq('machine', filterMachine.value);
    if (filterDateFrom.value) query = query.gte('job_date', filterDateFrom.value);
    if (filterDateTo.value) query = query.lte('job_date', filterDateTo.value);

    const { data, error } = await query.order('job_date', { ascending: false });

    if (error) {
      reportTableBody.innerHTML = `<tr><td colspan="5">Error loading data: ${error.message}</td></tr>`;
      return;
    }
    if (!data || data.length === 0) {
      reportTableBody.innerHTML = `<tr><td colspan="5">No matching records found.</td></tr>`;
      return;
    }

    reportTableBody.innerHTML = '';
    data.forEach(row => {
      const tr = document.createElement('tr');
      const jobIdTd = document.createElement('td');
      const link = document.createElement('a');
      link.href = '#';
      link.textContent = row.job_id;
      link.className = 'job-link';
      link.addEventListener('click', (e) => {
        e.preventDefault();
        showBarcodeModal(row.job_id);
      });
      jobIdTd.appendChild(link);
      tr.appendChild(jobIdTd);

      tr.innerHTML += `
        <td>${getJobTypeFullName(row.job_type)}</td>
        <td>${row.operator}</td>
        <td>${row.machine}</td>
        <td>${row.job_date}</td>
      `;
      reportTableBody.appendChild(tr);
    });
  }

  applyFiltersBtn.addEventListener('click', loadReport);

  // CSV download
  downloadCsvBtn.addEventListener('click', () => {
    let csvContent = 'Job ID,Job Type,Operator,Machine,Job Date\n';
    const rows = reportTableBody.querySelectorAll('tr');
    if (rows.length === 0) {
      alert('No data to download.');
      return;
    }
    rows.forEach(row => {
      const cells = row.querySelectorAll('td');
      const rowData = [];
      cells.forEach(cell => {
        let text = cell.textContent.replace(/"/g, '""');
        if (text.includes(',') || text.includes('"')) text = `"${text}"`;
        rowData.push(text);
      });
      csvContent += rowData.join(',') + '\n';
    });
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'job_report.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  // Associate Job Types Section
  const selectJobId = document.getElementById('selectJobId');
  const assocCheckboxes = document.querySelectorAll('.assocJobType');
  const associateBtn = document.getElementById('associateBtn');
  const associateResult = document.getElementById('associateResult');
  const associateList = document.getElementById('associateList');

  async function loadAssociateJobIds() {
    selectJobId.innerHTML = '<option value="">-- select --</option>';
    try {
      const { data, error } = await supabase
        .from('MoveComplyReport_md')
        .select('job_id, job_type, job_date')
        .in('job_type', ['L', 'M', 'A'])
        .order('job_date', { ascending: false });
      if (error) throw error;

      const uniqueJobIds = new Set();

      data.forEach(item => {
        if (/^[LMA]\d{5}J\d+$/.test(item.job_id)) {
          uniqueJobIds.add(item.job_id);
        }
      });

      const sortedJobIds = Array.from(uniqueJobIds).sort((a,b) => b.localeCompare(a));

      sortedJobIds.forEach(jid => {
        const option = document.createElement('option');
        option.value = jid;
        option.textContent = jid;
        selectJobId.appendChild(option);
      });
    } catch (err) {
      alert('Error loading job IDs for association: ' + err.message);
    }
  }

  associateBtn.addEventListener('click', async () => {
    associateList.innerHTML = '';
    associateResult.style.display = 'none';
    clearMessages();

    const baseJobId = selectJobId.value;
    if (!baseJobId) {
      alert('Please select a base Job ID.');
      return;
    }
    if (!/^[LMA]\d{5}J\d+$/.test(baseJobId)) {
      alert('Selected Job ID format is invalid. Expected format like L10625J2.');
      return;
    }

    const selectedTypes = Array.from(assocCheckboxes)
      .filter(chk => chk.checked)
      .map(chk => chk.value);

    if (selectedTypes.length === 0) {
      alert('Please select at least one Job Type to associate.');
      return;
    }

    const baseMatch = baseJobId.match(/^([LMA])(\d{1})(\d{4})J(\d+)$/);
    if (!baseMatch) {
      alert('Selected Job ID format is invalid. Expected format like L10625J2.');
      return;
    }
    const [_, baseType, machine, mmdd, seq] = baseMatch;

    // Filter out baseType from selectedTypes
    const jobTypesToCreate = selectedTypes.filter(t => t !== baseType);

    if (jobTypesToCreate.length === 0) {
      alert('Selected Job Type(s) to associate must be different from the base Job Type.');
      return;
    }

    try {
      for (const jt of jobTypesToCreate) {
        const newJobId = `${jt}${machine}${mmdd}J${seq}`;

        // Check if job exists
        const { data: existing, error: existingErr } = await supabase
          .from('MoveComplyReport_md')
          .select('id')
          .eq('job_id', newJobId)
          .single();

        // If error is "Not found" that's okay; else throw
        if (existingErr && !existingErr.message.includes('No rows')) throw existingErr;

        if (!existing) {
          await supabase
            .from('MoveComplyReport_md')
            .insert([{
              job_id: newJobId,
              operator: 'Associated',
              job_type: jt,
              machine,
              job_date: `${'20' + new Date().getFullYear().toString().slice(2)}-${mmdd.slice(0,2)}-${mmdd.slice(2,4)}`
            }]);
          const li = document.createElement('li');
          li.textContent = `Created associated Job ID: ${newJobId}`;
          associateList.appendChild(li);
        } else {
          const li = document.createElement('li');
          li.textContent = `Job ID already exists: ${newJobId}`;
          associateList.appendChild(li);
        }
      }
      associateResult.style.display = 'block';
    } catch (err) {
      alert('Error associating job types: ' + err.message);
    }
  });

  // Barcode Modal
  const barcodeModal = document.getElementById('barcodeModal');
  const modalJobIdSpan = document.getElementById('modalJobId');
  const modalBarcodeSvg = document.getElementById('modalBarcode');
  const closeModalBtn = document.getElementById('closeModalBtn');

  function showBarcodeModal(jobId) {
    modalJobIdSpan.textContent = jobId;
    JsBarcode(modalBarcodeSvg, jobId, { format: 'CODE128', width: 2, height: 80 });
    barcodeModal.classList.add('active');
    barcodeModal.focus();
  }

  closeModalBtn.addEventListener('click', () => {
    barcodeModal.classList.remove('active');
    modalBarcodeSvg.innerHTML = '';
  });

  barcodeModal.addEventListener('click', (e) => {
    if (e.target === barcodeModal) {
      barcodeModal.classList.remove('active');
      modalBarcodeSvg.innerHTML = '';
    }
  });

  // Utility: Map job_type code to full name for display
  function getJobTypeFullName(code) {
    return {
      L: 'Letters (L)',
      M: 'Machinable (M)',
      A: 'All - Merge Letters (A)',
      F: 'First Class Flats (F)',
      D: 'Standard Flats (D)',
      T: 'Standard Letters (T)'
    }[code] || code;
  }

  // Initialize with Create tab active
  switchTab('create');
</script>
</body>
</html>
