<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OCR Job Barcode Manager</title>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <style>
    body { font-family: sans-serif; background:#f9fafb; margin:0; padding:20px; color:#333; }
    .container { max-width:800px; margin:0 auto; background:#fff; padding:20px; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,0.1);}
    h1, h2 { color:#00407A; margin:0 0 10px; }
    .tabs { display:flex; gap:20px; margin-bottom:20px; }
    .tabs button { padding:10px 15px; background:#E87722; color:#fff; border:none; border-radius:4px; cursor:pointer; }
    .tabs button.active { background:#d56c1e; }
    .panel { display:none; }
    .panel.active { display:block; }
    label, select, input { width:100%; font-size:0.9em; margin-top:8px; }
    select, input { padding:8px; border:1px solid #ccc; border-radius:4px; }
    .row { display:flex; gap:10px; margin-top:10px; }
    .row > div { flex:1; }
    .row button { flex:1; }
    button.submit { background:#00407A; margin-top:15px; padding:12px; width:100%; color:#fff; font-size:1em; }
    button.submit:hover { background:#002f5a; }
    table { width:100%; margin-top:10px; border-collapse:collapse; }
    th, td { padding:8px; text-align:left; border:1px solid #ccc; font-size:0.9em; }
    th { background:#f2f2f2; }
    .barcode { margin-top:15px; text-align:center; }
    .error { color:red; font-size:0.9em; margin-top:5px; }
    .modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
             background:#fff; padding:20px; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,0.2); }
    .modal.active { display:block; }
    .modal .close { float:right; cursor:pointer; font-size:1.2em; }
  </style>
</head>
<body>
  <div class="container">
    <h1>OCR Job Barcode Manager</h1>
    <div class="tabs">
      <button class="active" onclick="showTab('create')">Create Jobs</button>
      <button onclick="showTab('report')">View Reports</button>
    </div>

    <div id="create" class="panel active">
      <label>Operator *</label>
      <input id="operator" placeholder="Enter name"/>
      <label>Job Type *</label>
      <select id="jobType">
        <option value="">--select--</option>
        <option value="L">L - First Class Letters</option>
        <option value="M">M - Machinable Letters</option>
        <option value="A">A - All, Merge Letter Jobs</option>
        <option value="F">F - First Class Flats</option>
        <option value="D">D - Standard Flats</option>
        <option value="T">T - Standard Letters</option>
      </select>
      <label>Machine *</label>
      <select id="machine"><option value="">--select--</option><option value="1">1</option><option value="2">2</option></select>
      <label>Date *</label>
      <input id="jobDate" type="date" />
      <div class="row">
        <button class="submit" onclick="handleCreate()">Create Job</button>
      </div>
      <div id="createError" class="error"></div>
      <div class="barcode" id="barcodeContainer"><svg id="barcodeSVG"></svg><div id="barcodeTxt"></div></div>
      <div>
        <label>Associate Extra Types</label>
        <select id="existingJobSelect"><option value="">--select existing Job ID--</option></select>
        <div class="row">
          <select id="associateType" multiple><option value="L">L</option><option value="M">M</option><option value="A">A</option></select>
          <button class="submit" onclick="associateTypes()">Associate</button>
        </div>
        <div id="assocError" class="error"></div>
      </div>
    </div>

    <div id="report" class="panel">
      <div class="row">
        <div><label>Operator</label><input id="fOperator"/></div>
        <div><label>Job Type</label><select id="fType"><option value="">All</option><option value="L">L</option><option value="M">M</option><option value="A">A</option><option value="F">F</option><option value="D">D</option><option value="T">T</option></select></div>
        <div><label>Machine</label><select id="fMachine"><option value="">All</option><option value="1">1</option><option value="2">2</option></select></div>
        <div><label>Date From</label><input type="date" id="fFrom"/></div>
        <div><label>Date To</label><input type="date" id="fTo"/></div>
      </div>
      <div class="row">
        <button class="submit" onclick="loadJobs()">Refresh</button>
        <button class="submit" onclick="exportCSV()">Export CSV</button>
      </div>
      <table><thead><tr><th>Job ID</th><th>Operator</th><th>Date</th><th>Type</th><th>Machine</th></tr></thead><tbody id="jobsTbl"></tbody></table>
    </div>

    <div id="barcodeModal" class="modal">
      <span class="close" onclick="closeModal()">Ã—</span>
      <svg id="modalBarcode"></svg>
      <div id="modalTxt" style="text-align:center; margin-top:10px;"></div>
    </div>
  </div>

  <script>
    // Supabase setup
    const SUPABASE_URL = "https://vwsqtcsxxzkxcrdcbbky.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ3c3F0Y3N4eHpreGNyZGNiYmt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3ODY3MTIsImV4cCI6MjA2NjM2MjcxMn0.rN559kMiLeExnVyZmXxRLg3yYjJwWfwDlkzPuFX7qeA";
    const TABLE = "jobs";

    document.getElementById("jobDate").value = new Date().toISOString().slice(0,10);

    function showTab(id) {
      document.querySelectorAll(".tabs button").forEach(b => b.classList.toggle("active", b.nextElementSibling ? b.onclick.name === id : false));
      document.querySelectorAll(".panel").forEach(p => p.classList.toggle("active", p.id === id));
      if (id === "report") loadJobs();
    }

    async function handleCreate() {
      const op = document.getElementById("operator").value.trim(),
            type = document.getElementById("jobType").value,
            mach = document.getElementById("machine").value,
            dt = document.getElementById("jobDate").value;

      const err = document.getElementById("createError");
      err.textContent = "";
      if (!op||!type||!mach||!dt) return err.textContent="All fields are required.";

      // fetch existing for suffix
      const { data: existing } = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}?job_type=eq.${type}&job_date=eq.${dt}&select=job_id`).then(r=>r.json());
      const takenNums = existing.map(j=>+j.job_id.slice(-1));
      let suffix=1; while(takenNums.includes(suffix)) suffix++;

      const [y,m,d] = dt.split("-");
      const id = type + mach + m.padStart(2,'0') + d.padStart(2,'0') + "J" + suffix;

      JsBarcode("#barcodeSVG", id, { format:"CODE128", width:2, height:60 });
      document.getElementById("barcodeTxt").textContent = id;

      await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}`, {
        method:"POST",
        headers:{
          apikey:SUPABASE_KEY,
          Authorization:`Bearer ${SUPABASE_KEY}`,
          "Content-Type":"application/json"
        },
        body: JSON.stringify({job_id:id, operator:op, job_type:type, machine:mach, job_date:dt})
      });

      loadJobs();
      populateExistingOptions();
    }

    async function loadJobs() {
      let url = `${SUPABASE_URL}/rest/v1/${TABLE}?select=*&order=job_date.desc`;
      const fOp = document.getElementById("fOperator").value.trim().toLowerCase(),
            fType = document.getElementById("fType").value,
            fMach = document.getElementById("fMachine").value,
            fFrom = document.getElementById("fFrom").value,
            fTo = document.getElementById("fTo").value;
      const { data: rows } = await fetch(url).then(r=>r.json());
      let data = rows.filter(r =>
        (!fOp || r.operator.toLowerCase().includes(fOp)) &&
        (!fType || r.job_type===fType) &&
        (!fMach || r.machine===fMach) &&
        (!fFrom || r.job_date>=fFrom) &&
        (!fTo || r.job_date<=fTo)
      );
      const tbody = document.getElementById("jobsTbl");
      tbody.innerHTML = data.map(r=>`
        <tr>
          <td><a href="#" onclick="showBarcode('${r.job_id}')">${r.job_id}</a></td>
          <td>${r.operator}</td><td>${r.job_date}</td><td>${r.job_type}</td><td>${r.machine}</td>
        </tr>`).join("");
    }

    function showBarcode(id) {
      JsBarcode("#modalBarcode", id, { format:"CODE128", width:2, height:60 });
      document.getElementById("modalTxt").textContent = id;
      document.getElementById("barcodeModal").classList.add("active");
    }

    function closeModal() {
      document.getElementById("barcodeModal").classList.remove("active");
    }

    async function populateExistingOptions() {
      const { data } = await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}?select=job_id`).then(r=>r.json());
      const sel = document.getElementById("existingJobSelect");
      sel.innerHTML = "<option value=''>--select existing--</option>" + [...new Set(data.map(x=>x.job_id))].map(id=>`<option>${id}</option>`).join("");
    }

    async function associateTypes() {
      const existing = document.getElementById("existingJobSelect").value;
      const types = [...document.getElementById("associateType").selectedOptions].map(o=>o.value);
      const err = document.getElementById("assocError");
      err.textContent="";
      if (!existing || types.length===0) return err.textContent="Select an existing Job ID and at least one type.";

      const dt = existing.slice(2,6);
      const m = existing.slice(1,2);
      const suffix = existing.slice(-1);
      const jobDate = document.getElementById("jobDate").value;

      for (const t of types) {
        const jobId = t + m + dt + "J" + suffix;
        JsBarcode("#barcodeSVG", jobId, {format:"CODE128", width:2, height:60});
        document.getElementById("barcodeTxt").textContent = jobId;
        await fetch(`${SUPABASE_URL}/rest/v1/${TABLE}`, {
          method:"POST",
          headers:{
            apikey:SUPABASE_KEY,
            Authorization:`Bearer ${SUPABASE_KEY}`,
            "Content-Type":"application/json"
          },
          body: JSON.stringify({job_id:jobId, operator: document.getElementById("operator").value || "", job_type:t, machine:m, job_date: jobDate})
        });
      }
      loadJobs();
    }

    function exportCSV() {
      const trs = document.querySelectorAll("#jobsTbl tr");
      const rows = [["Job ID","Operator","Date","Type","Machine"]];
      trs.forEach(tr=> rows.push([...tr.children].map(td=>td.textContent)));
      const csv = rows.map(r=>r.join(",")).join("\n");
      const blob = new Blob([csv],{type:"text/csv"});
      const a= document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="jobs_report.csv";
      a.click();
    }

    populateExistingOptions();
    loadJobs();
  </script>
</body>
</html>
