<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OCR Job Manager</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <style>
    body { font-family: sans-serif; background:#f9fafb; color:#333; margin:0; padding:20px; }
    h1 { text-align:center; color:#00407A; margin-bottom:20px; }
    nav { text-align:center; margin-bottom:20px; }
    nav button {
      padding:10px 20px;
      margin:0 5px;
      background:#00407A;
      color:#fff;
      border:none;
      border-radius:4px;
      cursor:pointer;
    }
    nav button.active { background:#E87722; }
    .container { max-width:600px; margin:0 auto; background:#fff; padding:20px; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    label { display:block; margin-top:10px; font-size:.9em; }
    select, input[type="text"], input[type="date"] {
      width:100%; padding:8px; margin-top:4px;
      border:1px solid #ccc; border-radius:4px;
    }
    button.submit-btn {
      width:100%; margin-top:15px; padding:10px;
      background:#E87722; color:#fff;
      border:none; border-radius:4px;
      font-size:1em; cursor:pointer;
    }
    .barcode, .modal-barcode { text-align:center; margin-top:20px; }
    .filter-row { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
    table { width:100%; border-collapse:collapse; margin-top:20px; font-size:0.9em; }
    th, td { border:1px solid #ccc; padding:8px; text-align:left; }
    th { background:#f1f1f1; }
    .modal {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);
      justify-content:center; align-items:center;
    }
    .modal-content {
      background:#fff; padding:20px; border-radius:8px; width:300px; text-align:center;
    }
    .modal-content svg { margin-top:10px; }
    .close-modal { margin-top:15px; background:#00407A; color:#fff; padding:6px 12px; border:none; border-radius:4px; cursor:pointer; }
    #createError {
      color: #b00020;
      font-weight: 600;
      margin-top: 8px;
      text-align: center;
    }
    #assocCheckboxes {
      margin-top: 8px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    #assocCheckboxes label {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.95em;
    }
  </style>
</head>
<body>
  <h1>OCR Job Manager</h1>
  <nav>
    <button id="tabCreate" class="active">Create Job</button>
    <button id="tabReport">Job Reports</button>
    <button id="tabAssociate">Associate Job Types</button>
  </nav>

  <div id="createSection" class="container">
    <label>Operator</label>
    <input id="operator" type="text" />
    <label>Job Type</label>
    <select id="jobType">
      <option value="">-- select --</option>
      <option value="L">First Class Letters (L)</option>
      <option value="M">Machinable Letters (M)</option>
      <option value="A">Merge FC & Machinable (A)</option>
      <option value="F">First Class Flats (F)</option>
      <option value="D">Standard Flats (D)</option>
      <option value="T">Standard Letters (T)</option>
    </select>
    <label>Machine Number</label>
    <select id="machine">
      <option value="">-- select --</option>
      <option value="1">OCR 1</option>
      <option value="2">OCR 2</option>
    </select>
    <label>Date</label>
    <input id="jobDate" type="date" />
    <button class="submit-btn" id="createBtn">Create Job</button>
    <div id="createError" style="display:none;">Please fill in all required fields before creating a job.</div>
    <div id="result" class="barcode" style="display:none;">
      <div>Job ID: <strong id="jobIdText"></strong></div>
      <svg id="barcode"></svg>
    </div>
  </div>

  <div id="reportSection" class="container" style="display:none;">
    <div class="filter-row">
      <select id="filterJobType"><option value="">All Job Types</option></select>
      <select id="filterOperator"><option value="">All Operators</option></select>
      <select id="filterMachine"><option value="">All Machines</option></select>
      <input type="date" id="filterStartDate" />
      <input type="date" id="filterEndDate" />
    </div>
    <button class="submit-btn" id="btnFilter">Apply Filters</button>
    <button class="submit-btn" id="btnDownload" style="background:#00407A; margin-top:10px;">Download CSV</button>
    <table>
      <thead>
        <tr><th>Job ID</th><th>Type</th><th>Operator</th><th>Machine</th><th>Date</th><th>Created</th></tr>
      </thead>
      <tbody id="jobsTable"></tbody>
    </table>
  </div>

  <div id="associateSection" class="container" style="display:none;">
    <label>Select Existing Job (L, M or A)</label>
    <select id="existingJobSelect"></select>
    <label>Select Job Types to Associate</label>
    <div id="assocCheckboxes">
      <!-- checkboxes inserted here dynamically -->
    </div>
    <button class="submit-btn" id="associateBtn">Generate Associated Job IDs</button>
    <div id="associateResult" class="barcode" style="display:none;"></div>
  </div>

  <div id="barcodeModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="modalJobId">
    <div class="modal-content">
      <div id="modalJobId" style="font-weight:bold; font-size:1.2em;"></div>
      <svg id="modalBarcode"></svg>
      <button class="close-modal" onclick="closeModal()">Close</button>
    </div>
  </div>

  <script>
    // Initialize Supabase client
    const SUPABASE_URL = 'https://vwsqtcsxxzkxcrdcbbky.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ3c3F0Y3N4eHpreGNyZGNiYmt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3ODY3MTIsImV4cCI6MjA2NjM2MjcxMn0.rN559kMiLeExnVyZmXxRLg3yYjJwWfwDlkzPuFX7qeA';
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Tabs elements and sections
    const tabCreate = document.getElementById('tabCreate');
    const tabReport = document.getElementById('tabReport');
    const tabAssociate = document.getElementById('tabAssociate');

    const createSection = document.getElementById('createSection');
    const reportSection = document.getElementById('reportSection');
    const associateSection = document.getElementById('associateSection');

    function showSection(section) {
      createSection.style.display = 'none';
      reportSection.style.display = 'none';
      associateSection.style.display = 'none';
      section.style.display = 'block';

      tabCreate.classList.remove('active');
      tabReport.classList.remove('active');
      tabAssociate.classList.remove('active');

      if(section === createSection) tabCreate.classList.add('active');
      if(section === reportSection) tabReport.classList.add('active');
      if(section === associateSection) tabAssociate.classList.add('active');
    }

    tabCreate.addEventListener('click', () => showSection(createSection));
    tabReport.addEventListener('click', () => {
      showSection(reportSection);
      populateFilters();
      fetchJobs();
    });
    tabAssociate.addEventListener('click', () => {
      showSection(associateSection);
      loadExistingJobs();
    });

    showSection(createSection); // default on load

    // Elements for Create Job
    const operatorEl = document.getElementById('operator');
    const jobTypeEl = document.getElementById('jobType');
    const machineEl = document.getElementById('machine');
    const dateEl = document.getElementById('jobDate');
    const btnCreate = document.getElementById('createBtn');
    const createError = document.getElementById('createError');
    const resultDiv = document.getElementById('result');
    const jobIdText = document.getElementById('jobIdText');
    const barcodeSvg = document.getElementById('barcode');

    // Initialize jobDate to today
    dateEl.value = new Date().toISOString().slice(0,10);

    // Create Job button click handler
    btnCreate.addEventListener('click', async () => {
      createError.style.display = 'none';
      resultDiv.style.display = 'none';

      const operator = operatorEl.value.trim();
      const jobType = jobTypeEl.value;
      const machine = machineEl.value;
      const jobDate = dateEl.value;

      if (!operator || !jobType || !machine || !jobDate) {
        createError.style.display = 'block';
        return;
      }

      // Generate jobId and sequence based on jobType and date
      const sequence = await getNextSequence(jobType, jobDate);
      const [year, month, day] = jobDate.split('-');
      const mmdd = month.padStart(2,'0') + day.padStart(2,'0');

      const jobId = `${jobType}${machine}${mmdd}J${sequence}`;

      // Insert to Supabase
      const { error } = await client.from('jobs').insert([{
        job_id: jobId,
        job_type: jobType,
        operator: operator,
        machine: machine,
        job_date: jobDate,
        created_at: new Date().toISOString()
      }]);

      if(error) {
        alert('Error creating job: ' + error.message);
        return;
      }

      // Show barcode
      jobIdText.textContent = jobId;
      JsBarcode(barcodeSvg, jobId, { format:'CODE128', width:2, height:80 });
      resultDiv.style.display = 'block';

      // Clear form (except date)
      operatorEl.value = '';
      jobTypeEl.value = '';
      machineEl.value = '';
    });

    // Get next sequence number for job type + date
    async function getNextSequence(jobType, jobDate) {
      const { data, error } = await client.from('jobs')
        .select('job_id')
        .eq('job_type', jobType)
        .eq('job_date', jobDate);

      if(error) {
        alert('Error fetching sequences: ' + error.message);
        return 1;
      }

      let maxSeq = 0;
      for(const row of data) {
        const match = row.job_id.match(/J(\d+)$/);
        if(match) {
          const seq = parseInt(match[1],10);
          if(seq > maxSeq) maxSeq = seq;
        }
      }
      return maxSeq + 1;
    }

    // -------- REPORTS TAB --------
    const filterJobType = document.getElementById('filterJobType');
    const filterOperator = document.getElementById('filterOperator');
    const filterMachine = document.getElementById('filterMachine');
    const filterStartDate = document.getElementById('filterStartDate');
    const filterEndDate = document.getElementById('filterEndDate');
    const btnFilter = document.getElementById('btnFilter');
    const btnDownload = document.getElementById('btnDownload');
    const jobsTable = document.getElementById('jobsTable');

    btnFilter.addEventListener('click', fetchJobs);
    btnDownload.addEventListener('click', downloadCSV);

    // Populate filter dropdowns from distinct values in DB
    async function populateFilters() {
      const jtRes = await client.from('jobs').select('job_type', { distinct:true });
      const opRes = await client.from('jobs').select('operator', { distinct:true });
      const mcRes = await client.from('jobs').select('machine', { distinct:true });

      fillSelect(filterJobType, jtRes.data.map(r => r.job_type), true);
      fillSelect(filterOperator, opRes.data.map(r => r.operator), true);
      fillSelect(filterMachine, mcRes.data.map(r => r.machine), true);
    }

    function fillSelect(selectEl, items, includeEmpty=false) {
      const oldValue = selectEl.value;
      selectEl.innerHTML = includeEmpty ? '<option value="">All</option>' : '';
      const sortedItems = [...new Set(items)].sort();
      for(const item of sortedItems) {
        if(item) {
          const opt = document.createElement('option');
          opt.value = item;
          opt.textContent = item;
          selectEl.appendChild(opt);
        }
      }
      if(oldValue) selectEl.value = oldValue;
    }

    async function fetchJobs() {
      let query = client.from('jobs').select('*');

      if(filterJobType.value) query = query.eq('job_type', filterJobType.value);
      if(filterOperator.value) query = query.eq('operator', filterOperator.value);
      if(filterMachine.value) query = query.eq('machine', filterMachine.value);
      if(filterStartDate.value) query = query.gte('job_date', filterStartDate.value);
      if(filterEndDate.value) query = query.lte('job_date', filterEndDate.value);

      const { data, error } = await query.order('created_at', { ascending: false });

      if(error) {
        alert('Error loading jobs: ' + error.message);
        return;
      }

      jobsTable.innerHTML = '';
      for(const j of data) {
        const tr = document.createElement('tr');

        const jobIdLink = document.createElement('a');
        jobIdLink.href = '#';
        jobIdLink.textContent = j.job_id;
        jobIdLink.addEventListener('click', (e) => {
          e.preventDefault();
          showBarcodeModal(j.job_id);
        });

        const tdJobId = document.createElement('td');
        tdJobId.appendChild(jobIdLink);

        tr.appendChild(tdJobId);
        tr.insertAdjacentHTML('beforeend', `
          <td>${j.job_type}</td>
          <td>${j.operator}</td>
          <td>${j.machine}</td>
          <td>${j.job_date}</td>
          <td>${new Date(j.created_at).toLocaleString()}</td>
        `);
        jobsTable.appendChild(tr);
      }
    }

    // Download filtered jobs as CSV
    async function downloadCSV() {
      let query = client.from('jobs').select('*');

      if(filterJobType.value) query = query.eq('job_type', filterJobType.value);
      if(filterOperator.value) query = query.eq('operator', filterOperator.value);
      if(filterMachine.value) query = query.eq('machine', filterMachine.value);
      if(filterStartDate.value) query = query.gte('job_date', filterStartDate.value);
      if(filterEndDate.value) query = query.lte('job_date', filterEndDate.value);

      const { data, error } = await query.order('created_at', { ascending: false });
      if(error) {
        alert('Error downloading CSV: ' + error.message);
        return;
      }

      if(data.length === 0) {
        alert('No data to download.');
        return;
      }

      const header = Object.keys(data[0]).join(',');
      const csvRows = data.map(row => Object.values(row).map(v => `"${v}"`).join(','));
      const csvContent = [header, ...csvRows].join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.create
