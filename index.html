<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OCR Job App</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <style>
    body { font-family: sans-serif; background:#f9fafb; color:#333; margin:0; padding:20px; }
    h1 { color:#00407A; font-size:1.6em; margin-bottom:10px; text-align:center; }
    nav { text-align:center; margin-bottom:20px; }
    nav button {
      padding:10px 20px;
      margin:0 5px;
      background:#00407A;
      color:#fff;
      border:none;
      border-radius:4px;
      cursor:pointer;
    }
    nav button.active { background:#E87722; }

    .container { max-width:500px; margin:0 auto; background:#fff; padding:20px; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    label { display:block; margin-top:10px; font-size:.9em; }
    select, input[type="text"], input[type="date"] {
      width:100%; padding:8px; margin-top:4px;
      border:1px solid #ccc; border-radius:4px;
    }
    button.submit-btn {
      width:100%; margin-top:15px; padding:10px;
      background:#E87722; color:#fff;
      border:none; border-radius:4px;
      font-size:1em; cursor:pointer;
    }
    button.submit-btn:hover { background:#d56c1e; }

    .barcode { text-align:center; margin-top:20px; }

    table { width:100%; border-collapse:collapse; margin-top:20px; font-size:0.9em; }
    th, td { border:1px solid #ccc; padding:8px; text-align:left; }
    th { background:#f1f1f1; }
    .filter-row { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
    .filter-row select, .filter-row input[type="date"] { flex:1; min-width:140px; }
  </style>
</head>
<body>
  <h1>OCR Job App</h1>

  <nav>
    <button id="tabCreate" class="active">Create Job</button>
    <button id="tabReport">Job Reports</button>
  </nav>

  <!-- Create Job Section -->
  <div id="createSection" class="container">
    <label>Operator</label>
    <input id="operator" type="text" placeholder="Your name" />

    <label>Job Type</label>
    <select id="jobType">
      <option value="">-- select --</option>
      <option value="L">First Class Letters (L)</option>
      <option value="M">Machinable Letters (M)</option>
      <option value="A">Merge FC & Machinable (A)</option>
      <option value="F">First Class Flats (F)</option>
      <option value="D">Standard Flats (D)</option>
      <option value="T">Standard Letters (T)</option>
    </select>

    <label>Machine Number</label>
    <select id="machine">
      <option value="">-- select --</option>
      <option value="1">OCR 1</option>
      <option value="2">OCR 2</option>
    </select>

    <label>Date</label>
    <input id="jobDate" type="date" />

    <button class="submit-btn" id="createBtn">Create Job</button>

    <div id="result" class="barcode" style="display:none;">
      <div>Job ID: <strong id="jobIdText"></strong></div>
      <svg id="barcode"></svg>
    </div>
  </div>

  <!-- Report Section -->
  <div id="reportSection" class="container" style="display:none;">
    <div class="filter-row">
      <select id="filterJobType"><option value="">All Job Types</option></select>
      <select id="filterOperator"><option value="">All Operators</option></select>
      <select id="filterMachine"><option value="">All Machines</option></select>
      <input type="date" id="filterStartDate" />
      <input type="date" id="filterEndDate" />
    </div>
    <button class="submit-btn" id="btnFilter">Apply Filters</button>
    <button class="submit-btn" id="btnDownload" style="background:#00407A; margin-top:10px;">Download CSV</button>
    <table id="jobsTable">
      <thead>
        <tr>
          <th>Job ID</th><th>Job Type</th><th>Operator</th><th>Machine</th><th>Job Date</th><th>Created</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const client = supabase.createClient(
        'https://vwsqtcsxxzkxcrdcbbky.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ3c3F0Y3N4eHpreGNyZGNiYmt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3ODY3MTIsImV4cCI6MjA2NjM2MjcxMn0.rN559kMiLeExnVyZmXxRLg3yYjJwWfwDlkzPuFX7qeA'
      );

      const operatorEl = document.getElementById('operator');
      const jobTypeEl = document.getElementById('jobType');
      const machineEl = document.getElementById('machine');
      const dateEl = document.getElementById('jobDate');
      const createBtn = document.getElementById('createBtn');
      const result = document.getElementById('result');
      const jobIdText = document.getElementById('jobIdText');
      const barcodeSvg = document.getElementById('barcode');

      const tabCreate = document.getElementById('tabCreate');
      const tabReport = document.getElementById('tabReport');
      const createSection = document.getElementById('createSection');
      const reportSection = document.getElementById('reportSection');

      const filterJobType = document.getElementById('filterJobType');
      const filterOperator = document.getElementById('filterOperator');
      const filterMachine = document.getElementById('filterMachine');
      const filterStartDate = document.getElementById('filterStartDate');
      const filterEndDate = document.getElementById('filterEndDate');
      const btnFilter = document.getElementById('btnFilter');
      const btnDownload = document.getElementById('btnDownload');
      const jobsTable = document.getElementById('jobsTable').querySelector('tbody');

      dateEl.value = new Date().toISOString().slice(0, 10);

      createBtn.addEventListener('click', async () => {
        const op = operatorEl.value.trim();
        const jt = jobTypeEl.value;
        const mc = machineEl.value;
        const dt = dateEl.value;
        if (!op || !jt || !mc || !dt) return alert('Please fill in all fields.');

        const [y, m, d] = dt.split('-');
        const mmdd = m.padStart(2, '0') + d.padStart(2, '0');

        // Query existing jobs with same job_type and job_date
        let { data: existingJobs, error } = await client
          .from('jobs')
          .select('job_id')
          .eq('job_type', jt)
          .eq('job_date', dt);

        if (error) {
          alert('Error checking existing jobs: ' + error.message);
          return;
        }

        // Extract existing sequence numbers from job_id strings
        // job_id format: jt + mc + mmdd + 'J' + seq
        // example: L11222J3 -> seq = 3
        let maxSeq = 0;
        if (existingJobs && existingJobs.length) {
          existingJobs.forEach(({ job_id }) => {
            const seqMatch = job_id.match(/J(\d+)$/);
            if (seqMatch) {
              const seqNum = parseInt(seqMatch[1], 10);
              if (seqNum > maxSeq) maxSeq = seqNum;
            }
          });
        }
        const seq = maxSeq + 1;

        const jobId = jt + mc + mmdd + 'J' + seq;
        jobIdText.textContent = jobId;
        result.style.display = 'block';
        JsBarcode(barcodeSvg, jobId, { format: 'CODE128', width: 2, height: 80 });

        // Insert new job record into Supabase
        await client.from('jobs').insert([{ job_id: jobId, job_type: jt, operator: op, machine: mc, job_date: dt }]);
      });

      function activateTab(tab) {
        tabCreate.classList.remove('active');
        tabReport.classList.remove('active');
        createSection.style.display = 'none';
        reportSection.style.display = 'none';
        if (tab === 'create') {
          tabCreate.classList.add('active');
          createSection.style.display = 'block';
        } else {
          tabReport.classList.add('active');
          reportSection.style.display = 'block';
          fetchJobs();
        }
      }

      tabCreate.addEventListener('click', () => activateTab('create'));
      tabReport.addEventListener('click', () => activateTab('report'));

      async function fetchJobs() {
        let { data: jobs } = await client.from('jobs').select('*').order('created_at', { ascending: false });
        const jt = filterJobType.value;
        const op = filterOperator.value;
        const mc = filterMachine.value;
        const sd = filterStartDate.value;
        const ed = filterEndDate.value;

        if (jt) jobs = jobs.filter(j => j.job_type === jt);
        if (op) jobs = jobs.filter(j => j.operator === op);
        if (mc) jobs = jobs.filter(j => j.machine === mc);
        if (sd) jobs = jobs.filter(j => j.job_date >= sd);
        if (ed) jobs = jobs.filter(j => j.job_date <= ed);

        populateDropdown(filterJobType, [...new Set(jobs.map(j => j.job_type))], 'All Job Types');
        populateDropdown(filterOperator, [...new Set(jobs.map(j => j.operator))], 'All Operators');
        populateDropdown(filterMachine, [...new Set(jobs.map(j => j.machine))], 'All Machines');

        jobsTable.innerHTML = '';
        jobs.forEach(j => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${j.job_id}</td><td>${j.job_type}</td><td>${j.operator}</td><td>${j.machine}</td><td>${j.job_date}</td><td>${new Date(j.created_at).toLocaleString()}</td>`;
          jobsTable.appendChild(tr);
        });
      }

      function populateDropdown(el, values, label) {
        const current = el.value;
        el.innerHTML = `<option value="">${label}</option>`;
        values.forEach(v => {
          const o = document.createElement('option');
          o.value = v;
          o.textContent = v;
          el.appendChild(o);
        });
        el.value = current;
      }

      function downloadCSV() {
        const headers = ['Job ID', 'Job Type', 'Operator', 'Machine', 'Job Date', 'Created'];
        const rows = Array.from(jobsTable.querySelectorAll('tr')).map(tr =>
          Array.from(tr.children).map(td => td.textContent)
        );
        const csvContent = [headers.join(','), ...rows.map(r => r.map(v => `"${v.replace(/"/g, '""')}"`).join(','))].join('\r\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'job_report.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      btnFilter.addEventListener('click', fetchJobs);
      btnDownload.addEventListener('click', downloadCSV);

      activateTab('create');
    });
  </script>
</body>
</html>
