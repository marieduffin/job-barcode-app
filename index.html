<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OCR Job Manager</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <style>
    body { font-family: sans-serif; background:#f9fafb; color:#333; margin:0; padding:20px; }
    nav { margin-bottom: 20px; }
    nav button {
      background:#00407A; color:#fff; border:none; padding:10px 20px;
      margin-right:10px; border-radius:4px; cursor:pointer; font-weight:600;
    }
    nav button.active { background:#E87722; }
    .container {
      max-width: 480px; margin:0 auto; background:#fff; padding:20px;
      border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { color:#00407A; font-size:1.5em; margin-bottom:10px; }
    label { display:block; margin-top:10px; font-size:.9em; }
    select,input[type=text],input[type=date] {
      width:100%; padding:8px; margin-top:4px; border:1px solid #ccc; border-radius:4px;
      box-sizing: border-box;
    }
    button.submit-btn {
      width:100%; margin-top:15px; padding:10px; background:#E87722;
      color:#fff; border:none; border-radius:4px; font-size:1em; cursor:pointer;
    }
    button.submit-btn:hover { background:#d56c1e; }
    .barcode { text-align:center; margin-top:20px; }
    table {
      width: 100%; border-collapse: collapse; margin-top: 15px;
    }
    th, td {
      border: 1px solid #ccc; padding: 8px; text-align: left;
    }
    th {
      background-color: #f0f0f0;
    }
    a.job-link {
      color: #00407A; cursor: pointer; text-decoration: underline;
    }
    .modal {
      display:none; position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.5); justify-content:center; align-items:center;
      z-index: 1000;
    }
    .modal-content {
      background: white; padding: 20px; border-radius: 6px;
      max-width: 320px; width: 90%; text-align: center;
      position: relative;
    }
    .modal-close {
      position: absolute; top: 8px; right: 12px; cursor: pointer;
      font-weight: bold; font-size: 1.2em;
    }
    /* Associate checkboxes inline */
    #assocCheckboxes label {
      display: inline-block;
      margin-right: 15px;
      font-weight: 600;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <nav>
    <button id="createTabBtn" class="active">Create Job</button>
    <button id="reportTabBtn">Job Reports</button>
    <button id="associateTabBtn">Associate Job Types</button>
  </nav>

  <!-- Create Job Section -->
  <section id="createSection" class="container">
    <h1>Create a new OCR Job</h1>
    <label for="operator">Operator *</label>
    <input id="operator" type="text" placeholder="Your name" required />
    <div id="operatorError" style="color:red; font-size:0.9em; display:none;">Please enter the operator name.</div>

    <label for="jobType">Job Type *</label>
    <select id="jobType" required>
      <option value="">-- select --</option>
      <option value="L">Letters</option>
      <option value="M">Machinable</option>
      <option value="A">All - Merge Jobs</option>
      <option value="F">First Class Flats</option>
      <option value="D">Standard Flats</option>
      <option value="T">Standard Letters</option>
    </select>
    <div id="jobTypeError" style="color:red; font-size:0.9em; display:none;">Please select a job type.</div>

    <label for="machine">Machine Number *</label>
    <select id="machine" required>
      <option value="">-- select --</option>
      <option value="1">OCR 1</option>
      <option value="2">OCR 2</option>
    </select>
    <div id="machineError" style="color:red; font-size:0.9em; display:none;">Please select a machine number.</div>

    <label for="jobDate">Date *</label>
    <input id="jobDate" type="date" required />
    <div id="jobDateError" style="color:red; font-size:0.9em; display:none;">Please select a date.</div>

    <button id="createBtn" class="submit-btn">Create Job</button>

    <div id="result" class="barcode" style="display:none;">
      <div>Job ID: <strong id="jobIdText"></strong></div>
      <svg id="barcode"></svg>
    </div>
  </section>

  <!-- Report Section -->
  <section id="reportSection" class="container" style="display:none;">
    <h1>Job Reports</h1>
    <label for="filterJobType">Filter by Job Type</label>
    <select id="filterJobType">
      <option value="">-- All --</option>
      <option value="L">Letters</option>
      <option value="M">Machinable</option>
      <option value="A">All - Merge Jobs</option>
      <option value="F">First Class Flats</option>
      <option value="D">Standard Flats</option>
      <option value="T">Standard Letters</option>
    </select>

    <label for="filterOperator">Filter by Operator</label>
    <input type="text" id="filterOperator" placeholder="Operator name" />

    <label for="filterMachine">Filter by Machine</label>
    <select id="filterMachine">
      <option value="">-- All --</option>
      <option value="1">OCR 1</option>
      <option value="2">OCR 2</option>
    </select>

    <label>Date range filter</label>
    <div style="display:flex; gap:10px;">
      <input type="date" id="filterDateFrom" style="flex:1;" />
      <input type="date" id="filterDateTo" style="flex:1;" />
    </div>

    <button id="loadReportBtn" class="submit-btn">Load Report</button>
    <button id="downloadReportBtn" class="submit-btn" style="margin-top:5px; background:#006633;">Download CSV</button>

    <table id="reportTable" style="display:none;">
      <thead>
        <tr>
          <th>Job ID</th>
          <th>Operator</th>
          <th>Job Type</th>
          <th>Machine</th>
          <th>Job Date</th>
          <th>Created At</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Associate Job Types Section -->
  <section id="associateSection" class="container" style="display:none;">
    <h1>Associate Job Types</h1>
    <label for="existingJobSelect">Select Existing Job (Letters, Machinable or All - Merge Jobs)</label>
    <select id="existingJobSelect"><option value="">-- Select Job --</option></select>

    <label>Select Job Types to Associate</label>
    <div id="assocCheckboxes"></div>

    <button id="associateBtn" class="submit-btn">Generate Associated Job IDs</button>

    <div id="associateResult" class="barcode" style="display:none; margin-top:15px;"></div>
  </section>

  <!-- Barcode Modal -->
  <div id="barcodeModal" class="modal">
    <div class="modal-content">
      <span id="modalClose" class="modal-close">&times;</span>
      <div>Job ID: <strong id="modalJobId"></strong></div>
      <svg id="modalBarcode" style="margin-top:10px;"></svg>
    </div>
  </div>

<script>
  // Supabase init
  const SUPABASE_URL = 'https://vwsqtcsxxzkxcrdcbbky.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ3c3F0Y3N4eHpreGNyZGNiYmt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3ODY3MTIsImV4cCI6MjA2NjM2MjcxMn0.rN559kMiLeExnVyZmXxRLg3yYjJwWfwDlkzPuFX7qeA';
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Tabs
  const createTabBtn = document.getElementById('createTabBtn');
  const reportTabBtn = document.getElementById('reportTabBtn');
  const associateTabBtn = document.getElementById('associateTabBtn');
  const createSection = document.getElementById('createSection');
  const reportSection = document.getElementById('reportSection');
  const associateSection = document.getElementById('associateSection');

  function showSection(section) {
    createSection.style.display = 'none';
    reportSection.style.display = 'none';
    associateSection.style.display = 'none';
    createTabBtn.classList.remove('active');
    reportTabBtn.classList.remove('active');
    associateTabBtn.classList.remove('active');

    section.style.display = 'block';
    if(section === createSection) createTabBtn.classList.add('active');
    if(section === reportSection) reportTabBtn.classList.add('active');
    if(section === associateSection) associateTabBtn.classList.add('active');
  }

  createTabBtn.addEventListener('click', () => showSection(createSection));
  reportTabBtn.addEventListener('click', () => showSection(reportSection));
  associateTabBtn.addEventListener('click', () => {
    showSection(associateSection);
    loadExistingJobs();
  });

  // Create Job logic
  const operatorEl = document.getElementById('operator');
  const jobTypeEl = document.getElementById('jobType');
  const machineEl = document.getElementById('machine');
  const dateEl = document.getElementById('jobDate');
  const btnCreate = document.getElementById('createBtn');
  const result = document.getElementById('result');
  const jobIdText = document.getElementById('jobIdText');
  const barcodeSvg = document.getElementById('barcode');

  // Error messages
  const operatorError = document.getElementById('operatorError');
  const jobTypeError = document.getElementById('jobTypeError');
  const machineError = document.getElementById('machineError');
  const jobDateError = document.getElementById('jobDateError');

  dateEl.value = new Date().toISOString().slice(0,10);

  function validateCreateForm() {
    let valid = true;
    operatorError.style.display = 'none';
    jobTypeError.style.display = 'none';
    machineError.style.display = 'none';
    jobDateError.style.display = 'none';

    if(!operatorEl.value.trim()) {
      operatorError.style.display = 'block';
      valid = false;
    }
    if(!jobTypeEl.value) {
      jobTypeError.style.display = 'block';
      valid = false;
    }
    if(!machineEl.value) {
      machineError.style.display = 'block';
      valid = false;
    }
    if(!dateEl.value) {
      jobDateError.style.display = 'block';
      valid = false;
    }
    return valid;
  }

  btnCreate.addEventListener('click', async () => {
    if(!validateCreateForm()) return;

    const op = operatorEl.value.trim();
    const jt = jobTypeEl.value;
    const mc = machineEl.value;
    const dt = dateEl.value;

    // Compose mmdd
    const [y,m,d] = dt.split('-');
    const mmdd = m.padStart(2,'0') + d.padStart(2,'0');

    // Determine next sequence number for this job type + date
    const { data: existingJobs, error } = await client.from('jobs')
      .select('job_id')
      .eq('job_type', jt)
      .eq('machine', mc)
      .eq('job_date', dt)
      .order('created_at', { ascending: true });

    if(error) {
      alert('Error checking existing jobs: ' + error.message);
      return;
    }

    // Get max sequence number for this combo
    let maxSeq = 0;
    const seqPattern = new RegExp(`^${jt}${mc}${mmdd}J(\\d+)$`);
    existingJobs.forEach(job => {
      const match = job.job_id.match(seqPattern);
      if(match) {
        const seqNum = parseInt(match[1], 10);
        if(seqNum > maxSeq) maxSeq = seqNum;
      }
    });

    const seq = maxSeq + 1;
    const jobId = `${jt}${mc}${mmdd}J${seq}`;

    // Insert record
    const { error: insertError } = await client.from('jobs').insert([{
      job_id: jobId,
      job_type: jt,
      operator: op,
      machine: mc,
      job_date: dt,
      created_at: new Date().toISOString()
    }]);

    if(insertError) {
      alert('Error inserting job: ' + insertError.message);
      return;
    }

    jobIdText.textContent = jobId;
    result.style.display = 'block';
    JsBarcode(barcodeSvg, jobId, { format:'CODE128', width:2, height:80 });

    // Clear form inputs except date (keep date as is)
    operatorEl.value = '';
    jobTypeEl.value = '';
    machineEl.value = '';
  });

  // Report Section logic
  const filterJobType = document.getElementById('filterJobType');
  const filterOperator = document.getElementById('filterOperator');
  const filterMachine = document.getElementById('filterMachine');
  const filterDateFrom = document.getElementById('filterDateFrom');
  const filterDateTo = document.getElementById('filterDateTo');
  const loadReportBtn = document.getElementById('loadReportBtn');
  const downloadReportBtn = document.getElementById('downloadReportBtn');
  const reportTable = document.getElementById('reportTable');
  const reportTbody = reportTable.querySelector('tbody');

  loadReportBtn.addEventListener('click', async () => {
    // Clear previous results
    reportTbody.innerHTML = '';
    reportTable.style.display = 'none';

    // Build filters
    let query = client.from('jobs').select('*').order('created_at', { ascending: false });

    if(filterJobType.value) query = query.eq('job_type', filterJobType.value);
    if(filterOperator.value.trim()) query = query.ilike('operator', `%${filterOperator.value.trim()}%`);
    if(filterMachine.value) query = query.eq('machine', filterMachine.value);
    if(filterDateFrom.value) query = query.gte('job_date', filterDateFrom.value);
    if(filterDateTo.value) query = query.lte('job_date', filterDateTo.value);

    const { data, error } = await query.limit(200);

    if(error) {
      alert('Error loading report: ' + error.message);
      return;
    }

    if(data.length === 0) {
      alert('No records found for the selected filters.');
      return;
    }

    data.forEach(row => {
      const tr = document.createElement('tr');

      const tdJobId = document.createElement('td');
      const jobLink = document.createElement('a');
      jobLink.textContent = row.job_id;
      jobLink.href = '#';
      jobLink.className = 'job-link';
      jobLink.addEventListener('click', (e) => {
        e.preventDefault();
        openModal(row.job_id);
      });
      tdJobId.appendChild(jobLink);
      tr.appendChild(tdJobId);

      tr.appendChild(createTd(row.operator));
      tr.appendChild(createTd(jobTypeLabel(row.job_type)));
      tr.appendChild(createTd(row.machine));
      tr.appendChild(createTd(row.job_date));
      tr.appendChild(createTd(new Date(row.created_at).toLocaleString()));

      reportTbody.appendChild(tr);
    });

    reportTable.style.display = 'table';
  });

  downloadReportBtn.addEventListener('click', async () => {
    // Re-use same query as report load to export CSV
    let query = client.from('jobs').select('*').order('created_at', { ascending: false });

    if(filterJobType.value) query = query.eq('job_type', filterJobType.value);
    if(filterOperator.value.trim()) query = query.ilike('operator', `%${filterOperator.value.trim()}%`);
    if(filterMachine.value) query = query.eq('machine', filterMachine.value);
    if(filterDateFrom.value) query = query.gte('job_date', filterDateFrom.value);
    if(filterDateTo.value) query = query.lte('job_date', filterDateTo.value);

    const { data, error } = await query.limit(200);

    if(error) {
      alert('Error downloading report: ' + error.message);
      return;
    }

    if(data.length === 0) {
      alert('No records found to download.');
      return;
    }

    // Convert data to CSV
    const csvRows = [];
    const headers = ['Job ID','Operator','Job Type','Machine','Job Date','Created At'];
    csvRows.push(headers.join(','));

    data.forEach(row
