<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OCR Job Barcode Generator</title>

  <!-- JsBarcode for barcode rendering -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

  <!-- Supabase client library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://vwsqtcsxxzkxcrdcbbky.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ3c3F0Y3N4eHpreGNiYmt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3ODY3MTIsImV4cCI6MjA2NjM2MjcxMn0.rN559kMiLeExnVyZmXxRLg3yYjJwWfwDlkzPuFX7qeA";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <style>
    body { font-family: sans-serif; background:#f9fafb; color:#333; margin:0; padding:20px; }
    .container { max-width: 700px; margin: 0 auto; background:#fff; padding:20px; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    h1 { color:#00407A; font-size:1.5em; margin-bottom:10px; }
    label { display:block; margin-top:10px; font-size:.9em; }
    select,input { width:100%; padding:8px; margin-top:4px; border:1px solid #ccc; border-radius:4px; box-sizing: border-box; }
    button { width:100%; margin-top:15px; padding:10px; background:#E87722; color:#fff; border:none; border-radius:4px; font-size:1em; cursor:pointer; }
    button:hover { background:#d56c1e; }
    .barcode { text-align:center; margin-top:20px; }

    .tabs {
      display: flex;
      justify-content: space-around;
      margin-bottom: 20px;
      border-bottom: 2px solid #ccc;
    }
    .tab {
      flex-grow: 1;
      padding: 12px;
      text-align: center;
      background: #eee;
      cursor: pointer;
      border-top-left-radius: 6px;
      border-top-right-radius: 6px;
      font-weight: bold;
    }
    .tab.active {
      background: #fff;
      border: 1px solid #ccc;
      border-bottom: none;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .error-msg {
      color: red;
      font-size: 0.85em;
      margin-top: 5px;
      display: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px 10px;
      font-size: 0.9em;
    }
    th {
      background: #f4f4f4;
      color: #00407A;
    }

    .modal {
      display: none;
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .close-btn {
      float: right;
      font-size: 1.5em;
      cursor: pointer;
      color: #999;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>OCR Job Barcode Generator</h1>

    <div class="tabs">
      <div class="tab active" data-tab="create">Create Job</div>
      <div class="tab" data-tab="report">Reports</div>
      <div class="tab" data-tab="associate">Associate Job Types</div>
    </div>

    <div id="create" class="tab-content active">
      <label>Operator</label>
      <input id="operator" type="text" placeholder="Your name" />
      <div id="operator-error" class="error-msg">Please enter an operator name.</div>

      <label>Job Type</label>
      <select id="jobType">
        <option value="">-- select --</option>
        <option value="L">Letters (L)</option>
        <option value="M">Machinable (M)</option>
        <option value="A">All - Merge Letters (A)</option>
        <option value="F">First Class Flats (F)</option>
        <option value="D">Standard Flats (D)</option>
        <option value="T">Standard Letters (T)</option>
      </select>
      <div id="jobType-error" class="error-msg">Please select a job type.</div>

      <label>Machine</label>
      <select id="machine">
        <option value="">-- select --</option>
        <option value="1">OCR 1</option>
        <option value="2">OCR 2</option>
      </select>
      <div id="machine-error" class="error-msg">Please select a machine.</div>

      <label>Date</label>
      <input id="jobDate" type="date" />
      <div id="jobDate-error" class="error-msg">Please select a date.</div>

      <button id="createBtn">Create Job</button>

      <div id="result" class="barcode" style="display:none;">
        <div>Job ID: <strong id="jobIdText"></strong></div>
        <svg id="barcode"></svg>
      </div>
    </div>
    <div id="report" class="tab-content">
      <label>Filter by Job Type</label>
      <select id="filterJobType">
        <option value="">All</option>
        <option value="L">Letters (L)</option>
        <option value="M">Machinable (M)</option>
        <option value="A">All - Merge Letters (A)</option>
        <option value="F">First Class Flats (F)</option>
        <option value="D">Standard Flats (D)</option>
        <option value="T">Standard Letters (T)</option>
      </select>

      <label>Operator</label>
      <input id="filterOperator" type="text" />

      <label>Machine</label>
      <select id="filterMachine">
        <option value="">All</option>
        <option value="1">OCR 1</option>
        <option value="2">OCR 2</option>
      </select>

      <label>Date Range</label>
      <input id="startDate" type="date" />
      <input id="endDate" type="date" />

      <button id="loadReport">Load Report</button>
      <button id="downloadCSV">Download CSV</button>

      <table id="reportTable" style="display:none;">
        <thead>
          <tr>
            <th>Job ID</th>
            <th>Operator</th>
            <th>Type</th>
            <th>Machine</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="associate" class="tab-content">
      <label>Select L Job ID</label>
      <select id="baseJobSelect"><option>Loading...</option></select>

      <label>Associate Job Types</label>
      <label><input type="checkbox" class="assocType" value="M" /> Machinable (M)</label>
      <label><input type="checkbox" class="assocType" value="A" /> All - Merge Letters (A)</label>

      <button id="associateBtn">Create Associated Jobs</button>
      <div id="assocResult" class="barcode" style="display:none;">
        <div>Created Job IDs:</div>
        <div id="assocIds"></div>
        <svg id="assocBarcode"></svg>
      </div>
    </div>
  </div>

  <div id="barcodeModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="document.getElementById('barcodeModal').style.display='none'">&times;</span>
      <div><strong id="modalJobId"></strong></div>
      <svg id="modalBarcode"></svg>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const tabs = document.querySelectorAll(".tab");
      const tabContents = document.querySelectorAll(".tab-content");

      tabs.forEach(tab => {
        tab.addEventListener("click", () => {
          tabs.forEach(t => t.classList.remove("active"));
          tabContents.forEach(tc => tc.classList.remove("active"));
          tab.classList.add("active");
          document.getElementById(tab.dataset.tab).classList.add("active");

          if (tab.dataset.tab === 'associate') loadBaseJobs();
        });
      });

      const operatorEl = document.getElementById('operator');
      const jobTypeEl = document.getElementById('jobType');
      const machineEl = document.getElementById('machine');
      const dateEl = document.getElementById('jobDate');
      const btn = document.getElementById('createBtn');
      const result = document.getElementById('result');
      const jobIdText = document.getElementById('jobIdText');
      const barcodeSvg = document.getElementById('barcode');
      dateEl.value = new Date().toISOString().slice(0,10);

      btn.addEventListener("click", async () => {
        document.querySelectorAll('.error-msg').forEach(el => el.style.display = 'none');

        const operator = operatorEl.value.trim();
        const jobType = jobTypeEl.value;
        const machine = machineEl.value;
        const jobDate = dateEl.value;

        if (!operator || !jobType || !machine || !jobDate) {
          if (!operator) document.getElementById('operator-error').style.display = 'block';
          if (!jobType) document.getElementById('jobType-error').style.display = 'block';
          if (!machine) document.getElementById('machine-error').style.display = 'block';
          if (!jobDate) document.getElementById('jobDate-error').style.display = 'block';
          return;
        }

        const [year, month, day] = jobDate.split("-");
        const mmdd = month.padStart(2,'0') + day.padStart(2,'0');

        const { data: existingJobs, error } = await supabase
          .from('jobs')
          .select('job_id')
          .ilike('job_id', `${jobType}__${mmdd}J%`)
          .order('created_at', { ascending: true });

        if (error) return alert('Error checking existing jobs');

        const numbers = existingJobs.map(j => {
          const match = j.job_id.match(/J(\d+)$/);
          return match ? parseInt(match[1]) : 0;
        });
        const next = numbers.length > 0 ? Math.max(...numbers)+1 : 1;

        const jobId = `${jobType}${machine}${mmdd}J${next}`;

        await supabase.from('jobs').insert({ job_id: jobId, operator, job_type: jobType, machine, job_date: jobDate });

        jobIdText.textContent = jobId;
        JsBarcode(barcodeSvg, jobId, { format:'CODE128', width:2, height:80 });
        result.style.display = 'block';
      });

      async function loadBaseJobs() {
        const { data, error } = await supabase
          .from('jobs')
          .select('job_id')
          .ilike('job_id', 'L%')
          .order('created_at', { ascending: false });

        const select = document.getElementById('baseJobSelect');
        select.innerHTML = data.map(d => `<option value="${d.job_id}">${d.job_id}</option>`).join('');
      }

      document.getElementById('associateBtn').addEventListener('click', async () => {
        const base = document.getElementById('baseJobSelect').value;
        const types = Array.from(document.querySelectorAll('.assocType:checked')).map(c => c.value);

        const match = base.match(/^L(\d)(\d{4})J(\d+)$/);
        if (!match) return alert('Selected Job ID format is invalid. Expected format like L10625J2.');

        const [, machine, mmdd, seq] = match;

        const jobDate = new Date();
        const fullDate = `${jobDate.getFullYear()}-${mmdd.slice(0,2)}-${mmdd.slice(2,4)}`;

        const results = [];
        for (let jt of types) {
          const jobId = `${jt}${machine}${mmdd}J${seq}`;
          const { error } = await supabase.from('jobs').insert({
            job_id: jobId,
            job_type: jt,
            machine,
            job_date: fullDate,
            operator: 'Associated'
          });
          if (!error) results.push(jobId);
        }

        const display = document.getElementById('assocResult');
        display.style.display = 'block';
        document.getElementById('assocIds').innerHTML = results.map(j => `<div>${j}</div>`).join('');
        if (results.length === 1) JsBarcode(document.getElementById('assocBarcode'), results[0], { format:'CODE128', width:2, height:80 });
      });

      document.getElementById('loadReport').addEventListener('click', async () => {
        const jobType = document.getElementById('filterJobType').value;
        const operator = document.getElementById('filterOperator').value;
        const machine = document.getElementById('filterMachine').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        let query = supabase.from('jobs').select('*').order('created_at', { ascending: false });

        if (jobType) query = query.ilike('job_type', jobType);
        if (operator) query = query.ilike('operator', `%${operator}%`);
        if (machine) query = query.eq('machine', machine);
        if (startDate) query = query.gte('job_date', startDate);
        if (endDate) query = query.lte('job_date', endDate);

        const { data, error } = await query;
        if (error) return alert('Error loading report');

        const table = document.getElementById('reportTable');
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';
        data.forEach(row => {
          const tr = document.createElement('tr');
          const tdId = document.createElement('td');
          tdId.innerHTML = `<a href="#" onclick="showBarcode('${row.job_id}')">${row.job_id}</a>`;
          tr.appendChild(tdId);
          tr.innerHTML += `<td>${row.operator}</td><td>${row.job_type}</td><td>${row.machine}</td><td>${row.job_date}</td>`;
          tbody.appendChild(tr);
        });
        table.style.display = 'table';
      });

      document.getElementById('downloadCSV').addEventListener('click', () => {
        const rows = Array.from(document.querySelectorAll('#reportTable tr'));
        const csv = rows.map(row => Array.from(row.children).map(cell => `"${cell.textContent}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'report.csv';
        a.click();
      });

      window.showBarcode = function(jobId) {
        document.getElementById('barcodeModal').style.display = 'flex';
        document.getElementById('modalJobId').textContent = jobId;
        JsBarcode(document.getElementById('modalBarcode'), jobId, { format: 'CODE128', width: 2, height: 80 });
      };
    });
  </script>
</body>
</html>
